name: Publish NuGet Package

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Extract Version from .csproj
      id: get_version
      run: |
        VERSION=$(grep -oPm1 "(?<=<Version>)[^<]+" src/Serilog.DestructuringPolicies.Redactor/Serilog.DestructuringPolicies.Redactor.csproj)
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Detected version: $VERSION"

    - name: Check if version already exists on NuGet
      id: check_version
      run: |
        PACKAGE_ID="Serilog.DestructuringPolicies.Redactor"
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        
        # Query the NuGet API (lowercasing the package ID as per NuGet's API requirements)
        LOWER_ID=$(echo "$PACKAGE_ID" | tr '[:upper:]' '[:lower:]')
        RESPONSE=$(curl -s "https://api.nuget.org/v3-flatcontainer/$LOWER_ID/index.json")
        
        # Check if the version is present in the versions array
        if echo "$RESPONSE" | jq -e ".versions | contains([\"$VERSION\"])" > /dev/null; then
          echo "::error::Version $VERSION already exists on NuGet.org. Please increment the <Version> in your .csproj file."
          exit 1
        else
          echo "Version $VERSION is new. Proceeding..."
        fi

    - name: Restore dependencies
      run: dotnet restore Serilog.DestructuringPolicies.Redactor.slnx

    - name: Build
      run: dotnet build Serilog.DestructuringPolicies.Redactor.slnx --configuration Release --no-restore /p:Version=${{ steps.get_version.outputs.VERSION }}

    - name: Run tests
      run: dotnet test Serilog.DestructuringPolicies.Redactor.slnx --configuration Release --no-build --verbosity normal

    - name: Pack NuGet package
      run: dotnet pack src/Serilog.DestructuringPolicies.Redactor/Serilog.DestructuringPolicies.Redactor.csproj --configuration Release --no-build --output ./artifacts /p:Version=${{ steps.get_version.outputs.VERSION }}

    - name: Publish to NuGet
      run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate